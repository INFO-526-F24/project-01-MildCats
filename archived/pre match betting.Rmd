```{r}
# --- Setup: Adding Binary Columns to the Dataset ---
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(here)

# Error handling for file path
tryCatch({
  file_path <- here("data", "soccer_main.csv")  
  data <- read.csv(file_path)
}, error = function(e) {
  stop("Error reading the file. Please check the file path: ", e$message)
})

# Check for required columns
required_columns <- c("hometeam", "awayteam", "b365ahh", "b365aha", "location")
missing_columns <- setdiff(required_columns, colnames(data))
if (length(missing_columns) > 0) {
  stop("Missing columns: ", paste(missing_columns, collapse = ", "))
}

# Add binary columns with safer conversion
data <- data %>%
  mutate(
    binary_home_win = as.integer(b365ahh < b365aha),
    binary_away_win = as.integer(b365aha < b365ahh),
    binary_draw = as.integer(b365ahh == b365aha),
    actual_outcome = case_when(
      binary_home_win == 1 ~ "Home Win",
      binary_away_win == 1 ~ "Away Win",
      binary_draw == 1 ~ "Draw",
      TRUE ~ NA_character_
    )
  )

# Safely write the updated data
tryCatch({
  write.csv(data, file_path, row.names = FALSE)
}, warning = function(w) {
  message("Warning while writing file: ", w$message)
}, error = function(e) {
  stop("Error writing file: ", e$message)
})

# --- Shiny Application ---
ui <- fluidPage(
  titlePanel("Accuracy of Pre-Match Betting Predictions"),
  sidebarLayout(
    sidebarPanel(
      selectInput(
        "location",
        "Select Location:",
        choices = sort(unique(data$location)),
        selected = NULL
      ),
      selectInput(
        "hometeam",
        "Select Home Team:",
        choices = sort(unique(data$hometeam)),
        selected = NULL
      ),
      selectInput(
        "awayteam",
        "Select Away Team:",
        choices = sort(unique(data$awayteam)),
        selected = NULL
      )
    ),
    mainPanel(
      plotlyOutput("accuracy_chart"),
      textOutput("accuracy_text")
    )
  )
)

server <- function(input, output, session) {
  # Update home and away team choices based on location selection
  observe({
    req(input$location)
    filtered_home_teams <- unique(data$hometeam[data$location == input$location])
    updateSelectInput(session, "hometeam", choices = sort(filtered_home_teams))
  })

  observe({
    req(input$hometeam)
    filtered_away_teams <- unique(data$awayteam[data$hometeam == input$hometeam & data$location == input$location])
    updateSelectInput(session, "awayteam", choices = sort(filtered_away_teams))
  })

  # Filter data based on inputs
  filtered_data <- reactive({
    req(input$location, input$hometeam, input$awayteam)
    df <- data %>%
      filter(location == input$location, hometeam == input$hometeam, awayteam == input$awayteam)

    validate(
      need(nrow(df) > 0, "No data available for the selected teams and location.")
    )

    df
  })

  # Calculate accuracy
  calculate_accuracy <- function(df) {
    if (nrow(df) == 0) return(list(accuracy = 0, total_matches = 0))

    df <- df %>%
      mutate(predicted_outcome = case_when(
        binary_home_win == 1 ~ "Home Win",
        binary_away_win == 1 ~ "Away Win",
        binary_draw == 1 ~ "Draw",
        TRUE ~ NA_character_
      )) %>%
      mutate(is_correct = ifelse(predicted_outcome == actual_outcome, 1, 0))

    total_correct <- sum(df$is_correct, na.rm = TRUE)
    total_matches <- nrow(df)
    accuracy <- ifelse(total_matches > 0, total_correct / total_matches, 0)

    list(accuracy = accuracy, total_matches = total_matches)
  }

  # Render bar chart
  output$accuracy_chart <- renderPlotly({
    req(input$location, input$hometeam, input$awayteam)

    df <- filtered_data()
    accuracy_result <- calculate_accuracy(df)

    accuracy_data <- data.frame(
      Outcome = c("Correct Predictions", "Incorrect Predictions"),
      Count = c(
        accuracy_result$accuracy * accuracy_result$total_matches, 
        (1 - accuracy_result$accuracy) * accuracy_result$total_matches
      )
    )

    # Fix for no matches available
    if (sum(accuracy_data$Count) == 0) {
      return(NULL)
    }

    p <- ggplot(accuracy_data, aes(x = Outcome, y = Count, fill = Outcome)) +
      geom_bar(stat = "identity") +
      labs(
        title = paste("Prediction Accuracy for", input$hometeam, "vs", input$awayteam, "at", input$location),
        x = "Outcome", 
        y = "Number of Matches"
      ) +
      theme_minimal() +
      scale_fill_brewer(palette = "Set1")

    ggplotly(p)
  })

  # Render accuracy text
  output$accuracy_text <- renderText({
    req(input$location, input$hometeam, input$awayteam)

    df <- filtered_data()
    accuracy_result <- calculate_accuracy(df)

    if (accuracy_result$total_matches == 0) {
      return("No matches available for the selected teams and location.")
    }

    paste0(
      "Accuracy: ", 
      sprintf("%.2f%%", accuracy_result$accuracy * 100), 
      " (", accuracy_result$total_matches, " matches)"
    )
  })
}

shinyApp(ui = ui, server = server)
```